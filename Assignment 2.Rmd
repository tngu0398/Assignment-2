---
title: "Assignment2_draft"
author: "Shiyuan Zhang"
date: "2023-06-07"
output:
  bookdown::html_document2: 
  fig_caption: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.align = "centre")

```

```{r LoadLibrary, echo = FALSE, warning = FALSE, message = FALSE}
library("tidyverse")
library("plotly")
library("bookdown")
library("rnaturalearth")
library("rnaturalearthdata")
library("maps")
library("dslabs")
```

```{r LoadData2}
#Load merged data
data_init <- read.csv("Alcohol/Merge_all_2010_2020_updated.csv")

#Subset dataset for the section
data_init_mod <- data_init %>%
  select(c("Entity", "Year", "Code", "Death_alcohol_use_disorders"))

```

## Research questions
Consuming too much alcohol and not being able to control drinking can harm an individual's physical or mental health and safety, causing to family or financial problems. Alcohol use disorders widely affect people across the globe. In this section, we will examine the death caused by alcohol use disorders worldwide and attempt to answer the following two questions:

1. Which countries worldwide were most affected by alcohol use disorders?

2. Has the situation improved or got worse over the past ten years?


### Countries in cold areas tend to be more affected by alcohol use disorders. {.tabset}

Belarus and Mongolia had the highest death rates of 21.80 and 17.05 per 100,000 people, respectively, followed by Russia, El Salvador, and Greenland (Table \@ref(tab:TableSummary1)).

Most of the countries with high death rates are in the subarctic or arctic zones in the northern hemisphere (Figure \@ref(fig:Visual1)). This is in line with findings from Figure \@ref(fig:). The cold and dark climates in the countries might have contributed to this observation directly or indirectly.

However, countries in hot and humid weather such as Guatemala and Brazil also had high death rates from alcohol abuse. Moreover, countries in the southern subarctic zone with high alcohol consumption levels only showed low to moderate death rates. Therefore, cultural, genetic, historical, and religious factors cannot be ignored when investigating the underlying reason of high death rates in these countries.

#### Plot

```{r Visual1, fig.cap = "Visual1"}
# Load world map data
world<-map_data("world")

# Create data set and merge with map data
data_visual1 <- data_init_mod %>%
  rename("region" = "Entity") %>%
  filter(!is.na(Death_alcohol_use_disorders) & !Year %in% c("2000", "2005")) %>%
  group_by(region) %>%
  summarize(Mean = mean(Death_alcohol_use_disorders, na.rm = TRUE))

data_visual1 <- left_join(world, data_visual1, by = "region")

# Create heat map
visual_1 <- ggplot(data_visual1,aes(long,lat,group = group, fill = Mean, label = region)) +
  geom_polygon(color="white") +
  scale_fill_gradient(low="lightblue",high="red", name = "Death")+
  theme(panel.background = element_rect(fill = "lightgrey")) +
  xlab("Longtitude") +
  ylab("Latitude") 

# Make plot interactive and add title and subtitle
visual_1_interactive <- ggplotly(visual_1) %>%
  layout(title = list(text = paste0("Death caused by alcohol use disorders",
                                    "<br>",
                                    "<sup>",
                                    "Average annual number of death from alcohol use disorder per 100,000 people",
                                    "</sup>")),
      annotations = list(x = 1, y = -0.1, text = "Caption.....", showarrow = F, xref='paper', yref='paper', xanchor='right', yanchor='auto', xshift=0, yshift=0, font=list(size=15, color="red")))

visual_1_interactive

```

#### Table

```{r TableSummary1}

data_table1 <- data_init_mod %>%
  filter(!is.na(Death_alcohol_use_disorders) & !Year %in% c("2000", "2005")) %>%
  group_by(Entity) %>%
  summarize(Mean = mean(Death_alcohol_use_disorders, na.rm = TRUE)) %>%
  arrange(desc(Mean)) %>%
  top_n(20)

# Make the table
table1 <- knitr::kable(data_table1,
                       digits = 2,
                       caption = "The top 20 countries with highest annual number of death caused by alcohol use disorders.")

table1
```


### The numbers flutuate, but we have seen some improvements. {.tabset}

Table \@ref(tab:TableSummary2) shows the standard deviations of %death from alcohol per country from 2010-2019. Most countries with high variances also had high average %death rates such as Kazakhstan, Guatemala, Russia, Mongolia, etc.

In figure \@ref(fig:Visualtrend), rate groups are classified by the mean annual %death rates over 2010-2019 into low (group1, <=1st quarter), medium (group2, <3rd quarter & >1st quarter) and high (group3, >=3st quarter). Only the top 5 countries are shown in each group. Note that the y axis are different in each subplot. (This is to illustrate the trends in each group.) Zooming in onto the global trends, we can see that:

-Most countries with both medium and high average annual %death from alcohol showed some improvements with a decreased %death rate.

-Countries with low average annual %death from alcohol had more flutuations and some even showed a slight increase.


#### Table
```{r TableSummary2}
data_table2 <- data_init_mod %>%
  filter(!is.na(Death_alcohol_use_disorders) & !Year %in% c("2000", "2005")) %>%
  group_by(Entity) %>%
  summarize(Standard_deviation = sd(Death_alcohol_use_disorders, na.rm = TRUE)) %>%
  arrange(desc(Standard_deviation)) %>%
  top_n(20)

# Make the table
table2 <- knitr::kable(data_table2,
                       digits = 2,
                       caption = "The top 20 countries with highest variance in number of death caused by alcohol use disorders.")

table2

```

#### Plot
```{r Visual_trend, fig.cap= "Visualtrend"}
# Classfy groups depending on the mean %death over 2010-2019
data_rank <- data_init_mod %>%
  group_by(Entity) %>%
  summarize(Mean = mean(Death_alcohol_use_disorders, na.rm = TRUE)) %>%
  mutate(rategroup = case_when(Mean >=2.752 ~ "3",
                               Mean <2.752 & Mean >0.920 ~ "2",
                               Mean <=0.920 ~ "1"))

# Create list of countries with high, medium, low %death rates
data_rank_low <- data_rank %>%
  filter(rategroup == "1") %>%
  arrange(desc(Mean))

data_rank_medium <- data_rank %>%
  filter(rategroup == "2") %>%
  arrange(desc(Mean))

data_rank_high <- data_rank %>%
  filter(rategroup == "3") %>%
  arrange(desc(Mean))

# Classify entities by 
data_rank2 <- data_init_mod %>%
  group_by(Entity) %>%
  mutate(rategroup = case_when(Entity %in% data_rank_high$Entity ~ "3",
                               Entity %in% data_rank_medium$Entity ~ "2",
                               Entity %in% data_rank_low$Entity ~ "1"))

# Create a line graph to show global trends
visual2 <- data_rank2 %>%
  filter(Year > "2009") %>%
  filter(Entity %in% head(data_rank_high$Entity, 10)|Entity %in% head(data_rank_medium$Entity, 10)|Entity %in% head(data_rank_low$Entity, 10)) %>%
  filter(!is.na(Death_alcohol_use_disorders)) %>%
  ggplot(aes(x = as.integer(Year), y = Death_alcohol_use_disorders, group = Entity, color = rategroup)) +
  geom_line() +
  scale_color_manual(values=c("#FAA19B", "#f66257", "#b73229"))+
  facet_grid(rategroup~., scales = "free") +
  xlab("Year") +
  ylab("%Death from alcohol") +
  ggtitle("Death changes from alcohol use disorders 2010-2019 per group")

visual_2_interactive <- ggplotly(visual2)

visual_2_interactive

```

